name: Publish Docker image

on:
  push:
    branches:
      - main
      - next
      - beta
      - host
      - io
    tags:
      - '**-host.*'
      - '**-io.*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  push_to_registry:
    name: Push Docker image to GitHub Container Registry (${{ matrix.variant }})
    runs-on: ubuntu-22.04
    if: >-
      ${{ github.repository == 'MisskeyIO/misskey' && ((github.ref_type == 'branch' && github.ref_name == matrix.branch)
      || (github.ref_type == 'tag' && matrix.tag_contains != '' && contains(github.ref_name,
      matrix.tag_contains))) }}
    strategy:
      matrix:
        include:
          - variant: main
            branch: main
            tag_contains: ''
          - variant: next
            branch: next
            tag_contains: ''
          - variant: beta
            branch: beta
            tag_contains: ''
          - variant: host
            branch: host
            tag_contains: '-host.'
          - variant: io
            branch: io
            tag_contains: '-io.'
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/misskeyio/misskey
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Prepare image metadata
        id: prep
        run: |
          format_ref_name() {
            echo "$1" | sed -e 's/\//-/g'
          }

          FORMATTED_REF_NAME="$(format_ref_name "${GITHUB_REF_NAME}")"
          FORMATTED_BRANCH_NAME="$(format_ref_name "${{ matrix.branch }}")"

          echo "FORMATTED_BRANCH_NAME=${FORMATTED_REF_NAME}" >> "$GITHUB_ENV"
          echo "CACHE_SCOPE=${FORMATTED_BRANCH_NAME}" >> "$GITHUB_ENV"

          {
            echo 'tags<<EOF'
            echo "ghcr.io/misskeyio/misskey:${FORMATTED_REF_NAME}"
            if [ "${FORMATTED_REF_NAME}" != "${FORMATTED_BRANCH_NAME}" ]; then
              echo "ghcr.io/misskeyio/misskey:${FORMATTED_BRANCH_NAME}"
            fi
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - name: Build and Push to GitHub Container Registry
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          push: true
          platforms: ${{ steps.buildx.outputs.platforms }}
          provenance: false
          labels: ${{ env.FORMATTED_BRANCH_NAME }}
          cache-from: type=registry,ref=ghcr.io/misskeyio/misskey:buildcache-${{ env.CACHE_SCOPE }}
          cache-to: type=registry,ref=ghcr.io/misskeyio/misskey:buildcache-${{ env.CACHE_SCOPE }},mode=max
          tags: ${{ steps.prep.outputs.tags }}

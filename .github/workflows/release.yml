name: Automated Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0000.00.0-mhq.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ github.event.inputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate version string
        run: |
          if [[ "${{ github.event.inputs.version }}" != *"-mhq."* ]]; then
            echo "Error: Version string must contain '-mhq.'"
            exit 1
          fi
          echo "Version validation passed: ${{ github.event.inputs.version }}"

      - name: Create version bump branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="version-bump-${{ github.event.inputs.version }}"
          git checkout -b $BRANCH_NAME

          sed -i 's/"version": "[^"]*"/"version": "${{ github.event.inputs.version }}"/' package.json
          sed -i 's/"version": "[^"]*"/"version": "${{ github.event.inputs.version }}"/' packages/misskey-js/package.json

          git add package.json packages/misskey-js/package.json
          git diff --cached --quiet || git commit -m "${{ github.event.inputs.version }}"

          if git rev-parse --verify HEAD >/dev/null 2>&1 && [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main 2>/dev/null || echo '')" ]; then
            git push origin $BRANCH_NAME -f
          else
            echo "No changes to push"
          fi

          EXISTING_PR=$(gh pr list --head $BRANCH_NAME --base main --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            PR_NUMBER=$EXISTING_PR
            PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
          else
            PR_URL=$(gh pr create \
              --base main \
              --head $BRANCH_NAME \
              --title "${{ github.event.inputs.version }}" \
              --body "Automated version bump to ${{ github.event.inputs.version }}" \
              --repo ${{ github.repository }})

            echo "PR created: $PR_URL"

            PR_NUMBER=$(echo $PR_URL | awk -F'/' '{print $NF}')
          fi

          gh pr merge $PR_URL --admin --squash --delete-branch --subject "${{ github.event.inputs.version }} (MisskeyIO#${PR_NUMBER})"

      - name: Wait for PR to be merged
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="version-bump-${{ github.event.inputs.version }}"
          echo "Waiting for PR to be merged..."

          for i in {1..60}; do
            sleep 5

            if ! git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
              echo "PR has been merged!"
              break
            fi

            if [ $i -eq 60 ]; then
              echo "Timeout waiting for PR to merge"
              exit 1
            fi
          done

  update-io-branch:
    runs-on: ubuntu-latest
    needs: version-bump
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update-io branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="update-io-${{ needs.version-bump.outputs.version }}"
          git checkout -b $BRANCH_NAME main

          git fetch origin io:io
          git merge io --no-edit --no-commit || true

          git checkout --ours package.json
          git checkout --ours packages/misskey-js/package.json

          IO_VERSION="${{ needs.version-bump.outputs.version }}"
          IO_VERSION="${IO_VERSION//-mhq./-io.}"

          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$IO_VERSION\"/" package.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$IO_VERSION\"/" packages/misskey-js/package.json

          git add .
          git diff --cached --quiet || git commit -m "Merge version '${{ needs.version-bump.outputs.version }}' into io"

          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main 2>/dev/null || echo '')" ]; then
            git push origin $BRANCH_NAME -f
          else
            echo "No changes to push"
          fi

          EXISTING_PR=$(gh pr list --head $BRANCH_NAME --base io --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            PR_URL=$(gh pr create \
              --base io \
              --head $BRANCH_NAME \
              --title "$IO_VERSION" \
              --body "Merge version \'${{ needs.version-bump.outputs.version }}\' into io branch as $IO_VERSION" \
              --repo ${{ github.repository }})

            echo "PR created: $PR_URL"
            PR_NUMBER=$(echo $PR_URL | awk -F'/' '{print $NF}')
          else
            echo "PR already exists: #$EXISTING_PR"
            PR_NUMBER=$EXISTING_PR
            PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
          fi

          if git diff origin/io HEAD -U0 | grep -q '<<<<<<< HEAD'; then
            echo "Conflict markers detected in diff. Manual resolution required; skipping auto merge."
            exit 1
          fi

          gh pr merge $PR_URL --auto --merge --delete-branch --subject "$IO_VERSION (MisskeyIO#${PR_NUMBER})"

  update-host-branch:
    runs-on: ubuntu-latest
    needs: version-bump
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update-host branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="update-host-${{ needs.version-bump.outputs.version }}"
          git checkout -b $BRANCH_NAME main

          git fetch origin host:host
          git merge host --no-edit --no-commit || true

          git checkout --ours package.json
          git checkout --ours packages/misskey-js/package.json

          HOST_VERSION="${{ needs.version-bump.outputs.version }}"
          HOST_VERSION="${HOST_VERSION//-mhq./-host.}"

          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$HOST_VERSION\"/" package.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$HOST_VERSION\"/" packages/misskey-js/package.json

          git add .
          git diff --cached --quiet || git commit -m "Merge version '${{ needs.version-bump.outputs.version }}' into host"

          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main 2>/dev/null || echo '')" ]; then
            git push origin $BRANCH_NAME -f
          else
            echo "No changes to push"
          fi

          EXISTING_PR=$(gh pr list --head $BRANCH_NAME --base host --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            PR_URL=$(gh pr create \
              --base host \
              --head $BRANCH_NAME \
              --title "$HOST_VERSION" \
              --body "Merge version \'${{ needs.version-bump.outputs.version }}\' into host branch as $HOST_VERSION" \
              --repo ${{ github.repository }})

            echo "PR created: $PR_URL"
            PR_NUMBER=$(echo $PR_URL | awk -F'/' '{print $NF}')
          else
            echo "PR already exists: #$EXISTING_PR"
            PR_NUMBER=$EXISTING_PR
            PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
          fi

          if git diff origin/host HEAD -U0 | grep -q '<<<<<<< HEAD'; then
            echo "Conflict markers detected in diff. Manual resolution required; skipping auto merge."
            exit 1
          fi

          gh pr merge $PR_URL --auto --merge --delete-branch --subject "$HOST_VERSION (MisskeyIO#${PR_NUMBER})"
